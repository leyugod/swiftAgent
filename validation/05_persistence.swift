#!/usr/bin/env swift

/*
 éªŒè¯è„šæœ¬ 05: æŒä¹…åŒ–å­˜å‚¨éªŒè¯
 
 éªŒè¯å†…å®¹ï¼š
 - SQLite æ•°æ®åº“åˆ›å»º
 - è®°å¿†æŒä¹…åŒ–å’Œæ¢å¤
 - æ¶ˆæ¯å†å²æŒä¹…åŒ–
 - ä¼šè¯ç®¡ç†
 - è·¨å®ä¾‹æ•°æ®æ¢å¤
*/

import Foundation

print("""
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ§ª éªŒè¯è„šæœ¬ 05: æŒä¹…åŒ–å­˜å‚¨éªŒè¯
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“‹ éªŒè¯é¡¹ç›®æ¸…å•ï¼š

1ï¸âƒ£ SQLite æ•°æ®åº“
   â–¡ æ•°æ®åº“æ–‡ä»¶åˆ›å»º
   â–¡ è¡¨ç»“æ„æ­£ç¡®
   â–¡ ç´¢å¼•åˆ›å»º
   â–¡ Schema ç‰ˆæœ¬ç®¡ç†

2ï¸âƒ£ è®°å¿†æŒä¹…åŒ–
   â–¡ æ·»åŠ è®°å¿†å¹¶ä¿å­˜
   â–¡ è·¨å®ä¾‹è¯»å–è®°å¿†
   â–¡ æ›´æ–°æŒä¹…åŒ–è®°å¿†
   â–¡ åˆ é™¤æŒä¹…åŒ–è®°å¿†
   â–¡ å‘é‡ embedding æŒä¹…åŒ–

3ï¸âƒ£ æ¶ˆæ¯å†å²æŒä¹…åŒ–
   â–¡ ä¿å­˜å¯¹è¯æ¶ˆæ¯
   â–¡ è·¨å®ä¾‹æ¢å¤å¯¹è¯
   â–¡ æ¶ˆæ¯é¡ºåºä¿æŒ
   â–¡ æ¶ˆæ¯å…ƒæ•°æ®å®Œæ•´

4ï¸âƒ£ æ•°æ®è¿ç§»
   â–¡ Schema ç‰ˆæœ¬å‡çº§
   â–¡ æ•°æ®å®Œæ•´æ€§ä¿æŒ
   â–¡ å‘åå…¼å®¹æ€§

5ï¸âƒ£ æ€§èƒ½å’Œå¯é æ€§
   â–¡ æ‰¹é‡æ’å…¥æ€§èƒ½
   â–¡ æŸ¥è¯¢æ€§èƒ½
   â–¡ æ•°æ®åº“å¤§å°
   â–¡ å¹¶å‘è®¿é—®

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“ éªŒè¯æ­¥éª¤ï¼š

### æ­¥éª¤ 1: è¿è¡Œ SQLite å­˜å‚¨æµ‹è¯•
```bash
swift test --filter SQLiteStorageTests
```

é¢„æœŸç»“æœï¼š
- âœ… testAddAndGetMemory: é€šè¿‡
- âœ… testBatchAdd: é€šè¿‡
- âœ… testSearchMemory: é€šè¿‡
- âœ… testVectorSearch: é€šè¿‡
- âœ… testGetRecent: é€šè¿‡
- âœ… testDeleteMemory: é€šè¿‡
- âœ… testClear: é€šè¿‡
- âœ… testCount: é€šè¿‡
- âœ… testPersistenceAcrossInstances: é€šè¿‡ â­

### æ­¥éª¤ 2: æ¶ˆæ¯å†å²æŒä¹…åŒ–æµ‹è¯•
```bash
swift test --filter PersistentMessageHistoryTests
```

é¢„æœŸç»“æœï¼š
- âœ… testAddAndGetMessages: é€šè¿‡
- âœ… testMessageOrdering: é€šè¿‡
- âœ… testMessageLimit: é€šè¿‡
- âœ… è·¨å®ä¾‹æ¢å¤æ¶ˆæ¯

### æ­¥éª¤ 3: æ•°æ®å®Œæ•´æ€§éªŒè¯

åˆ›å»ºæµ‹è¯•æ•°æ®ï¼š
```swift
// å®ä¾‹ 1: å†™å…¥æ•°æ®
let storage1 = try PersistentMemoryStore(dbPath: "test.db")
try await storage1.add(MemoryEntry(content: "Test memory"))
// é‡Šæ”¾å®ä¾‹
```

éªŒè¯æ•°æ®ï¼š
```swift
// å®ä¾‹ 2: è¯»å–æ•°æ®
let storage2 = try PersistentMemoryStore(dbPath: "test.db")
let memories = try await storage2.search(query: "", limit: 10)
// åº”è¯¥èƒ½å¤Ÿè¯»å–åˆ° "Test memory"
```

### æ­¥éª¤ 4: æ€§èƒ½åŸºå‡†æµ‹è¯•

æ‰¹é‡æ’å…¥æµ‹è¯•ï¼š
```bash
swift test --filter testBatchInsertPerformance
```

é¢„æœŸæ€§èƒ½ï¼š
- âœ… æ’å…¥ 100 æ¡: < 100ms
- âœ… æ’å…¥ 1000 æ¡: < 1s
- âœ… æŸ¥è¯¢ 100 æ¡: < 50ms
- âœ… å‘é‡æœç´¢ (1000æ¡): < 200ms

### æ­¥éª¤ 5: æ•°æ®åº“å¤§å°éªŒè¯
```bash
swift test --filter testDatabaseSize
```

é¢„æœŸç»“æœï¼š
- 1000 æ¡è®°å¿†: < 1MB
- 10000 æ¡è®°å¿†: < 10MB
- Embedding (768ç»´): æ¯æ¡ ~3KB

### æ­¥éª¤ 6: å¹¶å‘è®¿é—®æµ‹è¯•
```bash
swift test --filter testConcurrentPersistence
```

é¢„æœŸç»“æœï¼š
- âœ… å¤šçº¿ç¨‹å†™å…¥å®‰å…¨
- âœ… è¯»å†™å¹¶å‘æ­£ç¡®
- âœ… æ— æ•°æ®æŸå
- âœ… äº‹åŠ¡éš”ç¦»ç”Ÿæ•ˆ

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âœ… éªŒè¯é€šè¿‡æ ‡å‡†ï¼š
   â€¢ æ•°æ®åº“æ­£ç¡®åˆ›å»ºå’Œåˆå§‹åŒ–
   â€¢ æ•°æ®è·¨å®ä¾‹å®Œæ•´æ¢å¤
   â€¢ æ‰€æœ‰CRUDæ“ä½œæŒä¹…åŒ–
   â€¢ æ€§èƒ½ç¬¦åˆåŸºå‡†è¦æ±‚
   â€¢ å¹¶å‘è®¿é—®å®‰å…¨å¯é 

âŒ å¤±è´¥æ ‡å‡†ï¼š
   â€¢ æ•°æ®åº“åˆ›å»ºå¤±è´¥
   â€¢ æ•°æ®æ¢å¤ä¸å®Œæ•´
   â€¢ æ•°æ®æŒä¹…åŒ–å¤±è´¥
   â€¢ æ€§èƒ½ä¸¥é‡ä½äºåŸºå‡†
   â€¢ å¹¶å‘è®¿é—®å¯¼è‡´æ•°æ®æŸå

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ¯ æŒä¹…åŒ–å­˜å‚¨æ¶æ„éªŒè¯ï¼š

â–¡ SQLiteStorage å®ç°å®Œæ•´
â–¡ PersistentMemoryStore ç¬¦åˆ MemoryProtocol
â–¡ PersistentMessageHistory ç¬¦åˆ MessageHistoryProtocol
â–¡ Schema è¿ç§»æœºåˆ¶å¥å…¨
â–¡ æ•°æ®å®Œæ•´æ€§ä¿è¯

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“Š å®é™…æ•°æ®åº“æ£€æŸ¥ï¼š

æ•°æ®åº“æ–‡ä»¶ä½ç½®: ~/Library/Application Support/SwiftAgent/
é¢„æœŸè¡¨ç»“æ„:
  - memories (id, content, metadata, embedding, timestamp)
  - messages (id, role, content, tool_calls, timestamp)
  - schema_version (version, updated_at)

éªŒè¯å‘½ä»¤ï¼š
```bash
sqlite3 ~/Library/Application\\ Support/SwiftAgent/agent.db ".schema"
sqlite3 ~/Library/Application\\ Support/SwiftAgent/agent.db "SELECT count(*) FROM memories;"
```

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
""")
