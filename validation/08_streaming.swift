#!/usr/bin/env swift

/*
 éªŒè¯è„šæœ¬ 08: æµå¼å“åº”éªŒè¯
 
 éªŒè¯å†…å®¹ï¼š
 - StreamingChunk æ•°æ®æµ
 - Agent streamRun æ–¹æ³•
 - StreamingCallback å›è°ƒ
 - æµå¼å·¥å…·è°ƒç”¨ï¼ˆå¦‚æœæ”¯æŒï¼‰
*/

import Foundation

print("""
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ§ª éªŒè¯è„šæœ¬ 08: æµå¼å“åº”éªŒè¯
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“‹ éªŒè¯é¡¹ç›®æ¸…å•ï¼š

1ï¸âƒ£ æµå¼å“åº”åŸºç¡€
   â–¡ StreamingChunk æ•°æ®ç»“æ„
   â–¡ StreamingCallback å›è°ƒæœºåˆ¶
   â–¡ æµå¼æ•°æ®æ¥æ”¶
   â–¡ æ•°æ®å®Œæ•´æ€§éªŒè¯

2ï¸âƒ£ DeepSeek æµå¼æµ‹è¯•
   â–¡ åŸºç¡€æµå¼å¯¹è¯
   â–¡ æµå¼æ•°æ®å®æ—¶è¾“å‡º
   â–¡ æ•°æ®å—æ‹¼æ¥æ­£ç¡®
   â–¡ æœ€ç»ˆå“åº”å®Œæ•´

3ï¸âƒ£ Agent æµå¼é›†æˆ
   â–¡ Agent.streamRun() æ–¹æ³•
   â–¡ streamRunWithCallback() æ–¹æ³•
   â–¡ å›è°ƒå‡½æ•°æ­£ç¡®è§¦å‘
   â–¡ é”™è¯¯å¤„ç†

4ï¸âƒ£ æµå¼å·¥å…·è°ƒç”¨
   â–¡ æµå¼ç¯å¢ƒä¸‹å·¥å…·è°ƒç”¨
   â–¡ å·¥å…·è°ƒç”¨å›è°ƒ
   â–¡ æµå¼ + å·¥å…·ç»“åˆåœºæ™¯

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“ éªŒè¯æ­¥éª¤ï¼š

### æ­¥éª¤ 1: DeepSeek æµå¼æµ‹è¯•
```bash
export DEEPSEEK_API_KEY='sk-23939bb905f24af08f16d7b80f1f5cd5'
swift test --filter testStreamingChat
```

é¢„æœŸè¾“å‡ºï¼š
```
Starting streaming test...

Receiving chunks:
åœ¨
äºº
å·¥
æ™º
èƒ½
çš„
ä¸–
ç•Œ
é‡Œ
ï¼Œ
...

âœ… Received 127 chunks
âœ… Full content length: 234 characters
âœ… Final response matches streamed content
âœ… Token usage: 56 tokens
â±ï¸ Time to first chunk: 0.3s
â±ï¸ Total time: 2.1s
```

### æ­¥éª¤ 2: Streaming Callback æµ‹è¯•
```bash
swift test --filter testStreamingWithAgent
```

æµ‹è¯•ä»£ç ï¼š
```swift
let agent = Agent(
    name: "StreamingAgent",
    llmProvider: deepSeekProvider,
    systemPrompt: "ä½ æ˜¯ä¸€ä¸ªhelpfulçš„AIåŠ©æ‰‹"
)

var receivedContent: [String] = []
var toolCallsReceived: [ToolCallChunk] = []

let callback = StreamingCallback(
    onContent: { content in
        receivedContent.append(content)
        print(content, terminator: "")
    },
    onToolCall: { toolCall in
        toolCallsReceived.append(toolCall)
        print("\\nğŸ”§ Tool: \\(toolCall.name)")
    },
    onCompletion: { response in
        print("\\nâœ… Completed: \\(response.finishReason)")
    },
    onError: { error in
        print("\\nâŒ Error: \\(error)")
    }
)

let response = try await agent.streamRunWithCallback(
    input: "å†™ä¸€é¦–å…³äºSwiftçš„çŸ­è¯—",
    callback: callback
)
```

é¢„æœŸç»“æœï¼š
- âœ… onContent è¢«å¤šæ¬¡è°ƒç”¨
- âœ… å†…å®¹å®æ—¶è¾“å‡º
- âœ… onCompletion æœ€åè°ƒç”¨
- âœ… æœ€ç»ˆå“åº”å®Œæ•´

### æ­¥éª¤ 3: æµå¼æ€§èƒ½æµ‹è¯•
```bash
swift test --filter testStreamingPerformance
```

æ€§èƒ½æŒ‡æ ‡ï¼š
```
æµ‹è¯•: ç”Ÿæˆ 500 å­—æ–‡ç« 

éæµå¼æ¨¡å¼:
- é¦–å­—èŠ‚æ—¶é—´: 5.2ç§’ (ç­‰å¾…å®Œæ•´å“åº”)
- æ€»æ—¶é—´: 5.2ç§’
- ç”¨æˆ·ä½“éªŒ: âŒ é•¿æ—¶é—´ç­‰å¾…

æµå¼æ¨¡å¼:
- é¦–å­—èŠ‚æ—¶é—´: 0.3ç§’ âš¡
- æ€»æ—¶é—´: 5.1ç§’
- ç”¨æˆ·ä½“éªŒ: âœ… å®æ—¶åé¦ˆ

é¦–å­—èŠ‚æ”¹è¿›: 17x faster âš¡
```

### æ­¥éª¤ 4: æµå¼ + å·¥å…·è°ƒç”¨æµ‹è¯•
```bash
swift test --filter testStreamingWithTools
```

æµ‹è¯•åœºæ™¯ï¼š
```
User: "ä»Šå¤©åŒ—äº¬çš„å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ"

é¢„æœŸæµç¨‹:
1. Agent å¼€å§‹æµå¼å“åº”
2. è§¦å‘å·¥å…·è°ƒç”¨ (get_weather)
3. onToolCall å›è°ƒè§¦å‘
4. å·¥å…·æ‰§è¡Œå®Œæˆ
5. ç»§ç»­æµå¼è¾“å‡ºæœ€ç»ˆå›ç­”
```

é¢„æœŸè¾“å‡ºï¼š
```
è®©
æˆ‘
æŸ¥
ä¸€
ä¸‹
åŒ—
äº¬
çš„
å¤©
æ°”
ğŸ”§ Tool: get_weather
Arguments: {"city": "åŒ—äº¬"}
ä»Š
å¤©
åŒ—
äº¬
çš„
å¤©
æ°”
æ˜¯
æ™´
å¤©
ï¼Œ
æ¸©
åº¦
15
Â°C
ã€‚
âœ… Completed
```

### æ­¥éª¤ 5: é”™è¯¯å¤„ç†æµ‹è¯•
```bash
swift test --filter testStreamingErrorHandling
```

é”™è¯¯åœºæ™¯ï¼š
1. ç½‘ç»œä¸­æ–­
2. API é™æµ
3. æ— æ•ˆ token
4. è¶…æ—¶

é¢„æœŸç»“æœï¼š
- âœ… onError å›è°ƒè§¦å‘
- âœ… é”™è¯¯ä¿¡æ¯æ¸…æ™°
- âœ… å·²æ¥æ”¶æ•°æ®ä¿ç•™
- âœ… ä¼˜é›…é™çº§

### æ­¥éª¤ 6: å¹¶å‘æµå¼æµ‹è¯•
```bash
swift test --filter testConcurrentStreaming
```

æµ‹è¯•åœºæ™¯ï¼š
```
åŒæ—¶å¯åŠ¨ 5 ä¸ªæµå¼å¯¹è¯
éªŒè¯:
- æ•°æ®ä¸æ··æ·†
- å›è°ƒç‹¬ç«‹è§¦å‘
- æ€§èƒ½æ— æ˜æ˜¾ä¸‹é™
```

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âœ… éªŒè¯é€šè¿‡æ ‡å‡†ï¼š
   â€¢ æµå¼æ•°æ®æ­£ç¡®æ¥æ”¶
   â€¢ é¦–å­—èŠ‚æ—¶é—´ < 1ç§’
   â€¢ æ•°æ®å®Œæ•´æ— ä¸¢å¤±
   â€¢ å›è°ƒæœºåˆ¶å¯é 
   â€¢ å·¥å…·è°ƒç”¨æ­£å¸¸
   â€¢ é”™è¯¯å¤„ç†å¥å£®

âŒ å¤±è´¥æ ‡å‡†ï¼š
   â€¢ æµå¼æ•°æ®æŸå
   â€¢ é¦–å­—èŠ‚æ—¶é—´ > 3ç§’
   â€¢ æ•°æ®ä¸¢å¤±æˆ–é‡å¤
   â€¢ å›è°ƒæœªè§¦å‘
   â€¢ å·¥å…·è°ƒç”¨å¤±è´¥
   â€¢ é”™è¯¯å¯¼è‡´å´©æºƒ

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ¯ æµå¼å“åº”æ¶æ„éªŒè¯ï¼š

â–¡ StreamingLLMProviderProtocol å®ç°å®Œæ•´
â–¡ StreamingChunk æ•°æ®ç»“æ„æ­£ç¡®
â–¡ StreamingResponseBuilder æ„å»ºå‡†ç¡®
â–¡ StreamingCallback æœºåˆ¶å¯é 
â–¡ Agent æµå¼é›†æˆæ— ç¼

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“Š æµå¼ vs éæµå¼å¯¹æ¯”ï¼š

### ç”¨æˆ·ä½“éªŒ
| æŒ‡æ ‡ | éæµå¼ | æµå¼ | æ”¹è¿› |
|------|-------|------|------|
| é¦–æ¬¡åé¦ˆ | 5.2ç§’ | 0.3ç§’ | 17x âš¡ |
| æ€»æ—¶é—´ | 5.2ç§’ | 5.1ç§’ | ~ç›¸åŒ |
| æ„ŸçŸ¥é€Ÿåº¦ | â­â­ | â­â­â­â­â­ | æ˜¾è‘—æå‡ |
| å¯ä¸­æ–­æ€§ | âŒ | âœ… | âœ“ |

### é€‚ç”¨åœºæ™¯
- âœ… é•¿æ–‡æœ¬ç”Ÿæˆ
- âœ… å®æ—¶å¯¹è¯
- âœ… ç”¨æˆ·ä½“éªŒä¼˜å…ˆ
- âŒ æ‰¹é‡å¤„ç†
- âŒ ç®€çŸ­å“åº”

### å®ç°è¦†ç›–
- âœ… DeepSeekProvider
- âœ… OpenAIStreamingProvider  
- âœ… AnthropicStreamingProvider
- âœ… Agent æµå¼é›†æˆ
- âœ… é”™è¯¯å¤„ç†å’Œé‡è¯•

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ’¡ æµå¼å“åº”æœ€ä½³å®è·µï¼š

1. ä½¿ç”¨åœºæ™¯åˆ¤æ–­:
   - ç”Ÿæˆé•¿åº¦ > 50 tokens -> ä½¿ç”¨æµå¼
   - ç”¨æˆ·äº¤äº’åœºæ™¯ -> ä½¿ç”¨æµå¼
   - æ‰¹å¤„ç†/åå°ä»»åŠ¡ -> éæµå¼

2. å›è°ƒå¤„ç†:
   - onContent: å®æ—¶æ›´æ–° UI
   - onToolCall: æ˜¾ç¤ºå·¥å…·æ‰§è¡ŒçŠ¶æ€
   - onCompletion: æœ€ç»ˆå¤„ç†
   - onError: ç”¨æˆ·å‹å¥½é”™è¯¯æç¤º

3. æ€§èƒ½ä¼˜åŒ–:
   - ç¼“å†²è¾“å‡ºé¿å…è¿‡äºé¢‘ç¹UIæ›´æ–°
   - å·¥å…·è°ƒç”¨æ—¶æš‚åœæµå¼è¾“å‡º
   - åˆç†è®¾ç½®è¶…æ—¶æ—¶é—´

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
""")

